
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="zh"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>sOlOHsU's Blog<sup>&#946;</sup></title>
  <meta name="author" content="Solo Hsu">

  
  <meta name="description" content="首先看两个概念： 短连接： 连接->传输数据->关闭连接 HTTP是无状态的，浏览器和服务器每进行一次HTTP操作，就建立一次连接，但任务结束就中断连接。
也可以这样说：短连接是指SOCKET连接后发送后接收完数据后马上断开连接。 长连接： 连接->传输数据->保持连接 &ndash;> 传输数据 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.solohsu.com">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="sOlOHsU's Blog<sup>&#946;</sup>" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-49605896-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">sOlOHsU's Blog<sup>&#946;</sup></a></h1>
  
    <h2>灯火阑珊处</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.solohsu.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/categories">Categories</a></li>
  <li><a href="/blog/tags">Tags</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/19/dealing-with-tcp-stick-package/">TCP Stick Package</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-05-19T20:27:09+08:00" pubdate data-updated="true">May 19<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>首先看两个概念：</p>

<h4>短连接：</h4>

<p>连接->传输数据->关闭连接</p>

<p>HTTP是无状态的，浏览器和服务器每进行一次HTTP操作，就建立一次连接，但任务结束就中断连接。
也可以这样说：短连接是指SOCKET连接后发送后接收完数据后马上断开连接。</p>

<h4>长连接：</h4>

<p>连接->传输数据->保持连接 &ndash;> 传输数据-> 。。。 &ndash;>关闭连接。</p>

<p>长连接指建立SOCKET连接后不管是否使用都保持连接，但安全性较差。</p>

<p><strong>之所以出现粘包和半包现象,是因为TCP当中,只有流的概念,没有包的概念.</strong></p>

<h4>半包</h4>

<p>指接受方没有接受到一个完整的包，只接受了部分，这种情况主要是由于TCP为提高传输效率，将一个包分配的足够大，导致接受方并不能一次接受完。（在长连接和短连接中都会出现）。</p>

<h4>粘包与分包</h4>

<p>粘包指发送方发送的若干包数据到接收方接收时粘成一包，从接收缓冲区看，后一包数据的头紧接着前一包数据的尾。</p>

<p>出现粘包现象的原因是多方面的，它既可能由发送方造成，也可能由接收方造成。</p>

<p>发送方引起的粘包是由TCP协议本身造成的，<strong>TCP为提高传输效率，发送方往往要收集到足够多的数据后才发送一包数据</strong>。若连续几次发送的数据都很少，通常TCP会根据优化算法把这些数据合成一包后一次发送出去，这样接收方就收到了粘包数据。</p>

<p>接收方引起的粘包是由于接收方用户进程不及时接收数据，从而导致粘包现象。这是因为接收方先把收到的数据放在系统接收缓冲区，用户进程从该缓冲区取数据，若下一包数据到达时前一包数据尚未被用户进程取走，则下一包数据放到系统接收缓冲区时就接到前一包数据之后，而用户进程根据预先设定的缓冲区大小从系统接收缓冲区取数据，这样就一次取到了多包数据。</p>

<p>分包是指在出现粘包的时候我们的接收方要进行分包处理。（在长连接中都会出现）</p>

<h4>什么时候需要考虑半包的情况?</h4>

<p>从备注中我们了解到Socket内部默认的收发缓冲区大小大概是8K，但是我们在实际中往往需要考虑效率问题，重新配置了这个值，来达到系统的最佳状态。</p>

<p>一个实际中的例子：用mina作为服务器端，使用的缓存大小为10k，这里使用的是短连接，所有不用考虑粘包的问题。</p>

<p>问题描述：在并发量比较大的情况下，就会出现一次接受并不能完整的获取所有的数据。</p>

<p>处理方式：</p>

<ol>
<li>通过包头+包长+包体的协议形式，当服务器端获取到指定的包长时才说明获取完整。</li>
<li>指定包的结束标识，这样当我们获取到指定的标识时，说明包获取完整。</li>
</ol>


<h4>什么时候需要考虑粘包的情况?</h4>

<ol>
<li>当时短连接的情况下，不用考虑粘包的情况</li>
<li>如果发送数据无结构，如文件传输，这样发送方只管发送，接收方只管接收存储就ok，也不用考虑粘包</li>
<li>如果双方建立连接，需要在连接后一段时间内发送不同结构数据
处理方式：
接收方创建一预处理线程，对接收到的数据包进行预处理，将粘连的包分开</li>
</ol>


<p>注：粘包情况有两种，一种是粘在一起的包都是完整的数据包，另一种情况是粘在一起的包有不完整的包</p>

<p><strong>备注:</strong></p>

<p>一个包没有固定长度，以太网限制在46－1500字节，1500就是以太网的MTU，超过这个量，TCP会为IP数据报设置偏移量进行分片传输，现在一般可允许应用层设置8k（NTFS系）的缓冲区，8k的数据由底层分片，而应用看来只是一次发送。</p>

<p>windows的缓冲区经验值是4k,Socket本身分为两种，流(TCP)和数据报(UDP)，你的问题针对这两种不同使用而结论不一样。甚至还和你是用阻塞、还是非阻塞Socket来编程有关。</p>

<ol>
<li><p>通信长度</p>

<p> 这个是你自己决定的，没有系统强迫你要发多大的包，实际应该根据需求和网络状况来决定。对于TCP，这个长度可以大点，但要知道，Socket内部默认的收发缓冲区大小大概是8K，你可以用SetSockOpt来改变。</p>

<p> 但对于UDP，就不要太大，一般在1024至10K。注意一点，你无论发多大的包，IP层和链路层都会把你的包进行分片发送，一般局域网就是1500左右，广域网就只有几十字节。分片后的包将经过不同的路由到达接收方，对于UDP而言，要是其中一个分片丢失，那么接收方的IP层将把整个发送包丢弃，这就形成丢包。</p>

<p> 显然，要是一个UDP发包佷大，它被分片后，链路层丢失分片的几率就佷大，你这个UDP包，就佷容易丢失，但是太小又影响效率。最好可以配置这个值，以根据不同的环境来调整到最佳状态。</p>

<p> send()函数返回了实际发送的长度，在网络不断的情况下，它绝不会返回(发送失败的)错误，最多就是返回0。对于TCP你可以字节写一个循环发送。当send函数返回SOCKET_ERROR时，才标志着有错误。</p>

<p> 但对于UDP，你不要写循环发送，否则将给你的接收带来极大的麻烦。所以UDP需要用SetSockOpt来改变Socket内部Buffer的大小，以能容纳你的发包。</p>

<p> 明确一点，TCP作为流，发包是不会整包到达的，而是源源不断的到，那接收方就必须组包。而UDP作为消息或数据报，它一定是整包到达接收方。</p></li>
<li><p>关于接收</p>

<p> 一般的发包都有包边界，首要的就是你这个包的长度要让接收方知道，于是就有个包头信息，对于TCP，接收方先收这个包头信息，然后再收包数据。一次收齐整个包也可以，可要对结果是否收齐进行验证。这也就完成了组包过程。</p>

<p> UDP，那你只能整包接收了。要是你提供的接收Buffer过小，TCP将返回实际接收的长度，余下的还可以收，而UDP不同的是，余下的数据被丢弃并返回WSAEMSGSIZE错误。</p>

<p> 注意TCP，要是你提供的Buffer佷大，那么可能收到的就是多个发包，你必须分离它们，还有就是当Buffer太小，而一次收不完Socket内部的数据，那么Socket接收事件(OnReceive)，可能不会再触发，使用事件方式进行接收时，密切注意这点。这些特性就是体现了流和数据包的区别。</p></li>
</ol>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/04/26/java-classloader/">Java基础之ClassLoader</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-04-26T21:47:23+08:00" pubdate data-updated="true">Apr 26<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>什么是类加载器</h3>

<p>类加载器是一个用来加载类文件的类。Java源代码通过javac编译器编译成类文件。然后JVM来执行类文件中的字节码来执行程序。类加载器负责加载文件系统、网络或其他来源的类文件。有三种默认使用的类加载器：Bootstrap类加载器、Extension类加载器和System类加载器（在HotSpot中的实现叫作Application类加载器）。每种类加载器都有设定好从哪里加载类。</p>

<ul>
<li>Bootstrap类加载器负责加载rt.jar中的JDK类文件，它是所有类加载器的父加载器。Bootstrap类加载器没有任何父类加载器，如果你调用<code>String.class.getClassLoader()</code>，会返回<code>null</code>，任何基于此的代码会抛出<code>NUllPointerException</code>异常。Bootstrap加载器被称为初始类加载器。</li>
<li>而Extension将加载类的请求先委托给它的父加载器，也就是Bootstrap，如果没有成功加载的话，再从jre/lib/ext目录下或者java.ext.dirs系统属性定义的目录下加载类。Extension加载器由<code>sun.misc.Launcher$ExtClassLoader</code>实现。</li>
<li>第三种默认的加载器就是System类加载器（又叫作Application类加载器）了。它负责从classpath环境变量中加载某些应用相关的类，classpath环境变量通常由-classpath或-cp命令行选项来定义，或者是JAR中的Manifest的classpath属性。Application类加载器是Extension类加载器的子加载器。通过<code>sun.misc.Launcher$AppClassLoader</code>实现。</li>
</ul>


<p>除了Bootstrap类加载器是大部分由C++来写的，其他的类加载器都是通过继承<code>java.lang.ClassLoader</code>来实现的。</p>

<p><img src="/images/java_classloader_hierarchy.png"></p>

<h3>类加载器的工作原理</h3>

<p>类加载器的工作原理基于三个机制：委托、可见性和单一性。这一节，我们来详细看看这些规则，并用一个实例来理解工作原理。下面显示的是类加载器使用委托机制的工作原理。</p>

<h4>委托机制</h4>

<p>当一个类加载和初始化的时候，类仅在有需要加载的时候被加载。假设你有一个应用需要的类叫作<code>Abc.class</code>，首先加载这个类的请求由Application类加载器委托给它的父类加载器Extension类加载器，然后再委托给Bootstrap类加载器。Bootstrap类加载器会先看看rt.jar中有没有这个类，因为并没有这个类，所以这个请求由回到Extension类加载器，它会查看jre/lib/ext目录下有没有这个类，如果这个类被Extension类加载器找到了，那么它将被加载，而Application类加载器不会加载这个类；而如果这个类没有被Extension类加载器找到，那么再由Application类加载器从classpath中寻找。</p>

<h4>可见性机制</h4>

<p>根据可见性机制，子类加载器可以看到父类加载器加载的类，而反之则不行。所以下面的例子中，当Abc.class已经被Application类加载器加载过了，然后如果想要使用Extension类加载器加载这个类，将会抛出<code>java.lang.ClassNotFoundException</code>异常。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'> <span class="kn">package</span> <span class="n">test</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kn">import</span> <span class="nn">java.util.logging.Level</span><span class="o">;</span>
</span><span class='line'>    <span class="kn">import</span> <span class="nn">java.util.logging.Logger</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/**</span>
</span><span class='line'><span class="cm">     * Java program to demonstrate How ClassLoader works in Java,</span>
</span><span class='line'><span class="cm">     * in particular about visibility principle of ClassLoader.</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * @author Javin Paul</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">ClassLoaderTest</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span> <span class="n">args</span><span class="o">[])</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="c1">//printing ClassLoader of this class</span>
</span><span class='line'>                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;ClassLoaderTest.getClass().getClassLoader() : &quot;</span>
</span><span class='line'>                                     <span class="o">+</span> <span class="n">ClassLoaderTest</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">());</span>
</span><span class='line'>
</span><span class='line'>                <span class="c1">//trying to explicitly load this class again using Extension class loader</span>
</span><span class='line'>                <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&quot;test.ClassLoaderTest&quot;</span><span class="o">,</span> <span class="kc">true</span>
</span><span class='line'>                                <span class="o">,</span>  <span class="n">ClassLoaderTest</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">().</span><span class="na">getParent</span><span class="o">());</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ClassNotFoundException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">Logger</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">ClassLoaderTest</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">()).</span><span class="na">log</span><span class="o">(</span><span class="n">Level</span><span class="o">.</span><span class="na">SEVERE</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>输出：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ClassLoaderTest.getClass().getClassLoader() : sun.misc.Launcher$AppClassLoader@601bb1
</span><span class='line'>  16/08/2012 2:43:48 AM test.ClassLoaderTest main
</span><span class='line'>  SEVERE: null
</span><span class='line'>  java.lang.ClassNotFoundException: test.ClassLoaderTest
</span><span class='line'>          at java.net.URLClassLoader$1.run(URLClassLoader.java:202)
</span><span class='line'>          at java.security.AccessController.doPrivileged(Native Method)
</span><span class='line'>          at java.net.URLClassLoader.findClass(URLClassLoader.java:190)
</span><span class='line'>          at sun.misc.Launcher$ExtClassLoader.findClass(Launcher.java:229)
</span><span class='line'>          at java.lang.ClassLoader.loadClass(ClassLoader.java:306)
</span><span class='line'>          at java.lang.ClassLoader.loadClass(ClassLoader.java:247)
</span><span class='line'>          at java.lang.Class.forName0(Native Method)
</span><span class='line'>          at java.lang.Class.forName(Class.java:247)
</span><span class='line'>          at test.ClassLoaderTest.main(ClassLoaderTest.java:29)</span></code></pre></td></tr></table></div></figure>


<h4>单一性机制</h4>

<p>根据这个机制，父加载器加载过的类不能被子加载器加载第二次。虽然重写违反委托和单一性机制的类加载器是可能的，但这样做并不可取。你写自己的类加载器的时候应该严格遵守这三条机制。</p>

<h3>如何显式的加载类</h3>

<p>Java提供了显式加载类的API：<code>Class.forName(classname)</code>和<code>Class.forName(classname, initialized, classloader)</code>。就像上面的例子中，你可以指定类加载器的名称以及要加载的类的名称。类的加载是通过调用<code>java.lang.ClassLoader的loadClass()</code>方法，而<code>loadClass()</code>方法则调用了<code>findClass()</code>方法来定位相应类的字节码。在这个例子中Extension类加载器使用了<code>java.net.URLClassLoader</code>，它从JAR和目录中进行查找类文件，所有以”/”结尾的查找路径被认为是目录。如果<code>findClass()</code>没有找到那么它会抛出<code>java.lang.ClassNotFoundException</code>异常，而如果找到的话则会调用<code>defineClass()</code>将字节码转化成类实例，然后返回。</p>

<h3>什么地方使用类加载器</h3>

<p>类加载器是个很强大的概念，很多地方被运用。最经典的例子就是AppletClassLoader，它被用来加载Applet使用的类，而Applets大部分是在网上使用，而非本地的操作系统使用。使用不同的类加载器，你可以从不同的源地址加载同一个类，它们被视为不同的类。J2EE使用多个类加载器加载不同地方的类，例如WAR文件由Web-app类加载器加载，而EJB-JAR中的类由另外的类加载器加载。有些服务器也支持热部署，这也由类加载器实现。你也可以使用类加载器来加载数据库或者其他持久层的数据。</p>

<p>参考资料：</p>

<ul>
<li><a href="http://www.importnew.com/6581.html">http://www.importnew.com/6581.html</a></li>
<li><a href="http://www.blogjava.net/mstar/archive/2006/08/24/65505.html">http://www.blogjava.net/mstar/archive/2006/08/24/65505.html</a></li>
<li><a href="http://blog.csdn.net/xyang81/article/details/7292380">http://blog.csdn.net/xyang81/article/details/7292380</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/04/22/2014-alibaba-summer-intern-2nd-interview/">阿里校园招聘暑期实习二面面经</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-04-22T14:42:16+08:00" pubdate data-updated="true">Apr 22<span>nd</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>来自2015届校招群里的波波同学：</p>

<ol>
<li>自我介绍</li>
<li>最出彩的项目，聊项目，遇到的难题</li>
<li>WebService相关相关知识，写wsdl文档的格式、webservice、uddi、wsdl（说明文档）、soap</li>
<li>spring的理解，spring的Ioc原理、并发性（内存的占用怎么样）</li>
<li>java的jvm的内存模式（堆。栈、代码区、数据区）、内存回收机制（自己回收）、jvm内存的设置（不知道）</li>
<li>编程：找出字符串中的url</li>
<li>HR：你研究生和本科生最大的进步是什么（目标更加明确，对自身更加了解）</li>
<li>还找了其他的实习吗？进度？你为什么选择阿里？（分布式计算）</li>
<li>你最近有没有感兴趣的技术，技术进步的主要手段（网络）。</li>
</ol>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/04/21/dot-net-compact-framework-background-task/">在.NET Compact Framework中使用后台任务</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-04-21T11:12:43+08:00" pubdate data-updated="true">Apr 21<span>st</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>最近在做一个Windows Mobile平台客户端的项目，需要在后台线程中连接服务器并进行消息的发送和接收。</p>

<h3>后台任务</h3>

<p>由于之前也没接触过C#，所以查找了一下相关资料，发现基本上有使用BackgroundWorker和直接使用Thread两种实现方式。</p>

<p>BackgroundWorker看名字应该类似于Android平台中AsynTask，为了方便编写简单的非UI后台任务而对Thread进行了封装。由于之前的Android客户端中收发消息都是使用的AsynTask，并且后台任务的逻辑也比较简单，BackgroundWorker完全能够满足要求。</p>

<p>写代码时发现没有找到BackgroundWorker这个类，想到Windows Mobile平台使用的是.NET Compact Framework，江湖人称.NET CF,Google了一下，果然CF是不支持BackgroundWorker的，只好另寻他法。</p>

<p>Google之后发现已经有人问过这个问题：</p>

<ul>
<li><a href="http://stackoverflow.com/questions/1323596/net-compact-fw-3-5-background-worker" title=".NET Compact Fw 3.5: Background worker">http://stackoverflow.com/questions/1323596/net-compact-fw-3-5-background-worker</a></li>
</ul>


<p>回答中有人建议自己写一个BackgroundWorker，也有人建议参考微软官方的这篇文章：</p>

<ul>
<li><a href="http://msdn.microsoft.com/en-us/library/aa446488.aspx" title="Microsoft .NET Compact Framework Background Processing Techniques">http://msdn.microsoft.com/en-us/library/aa446488.aspx</a></li>
</ul>


<p>这篇文章中提到了在.NET CF中创建后台任务的三种方式：</p>

<ol>
<li>异步访问Web Service</li>
<li>线程池</li>
<li>显示的创建线程</li>
</ol>


<p>根据我们的应用场景我最终选择了线程池这种比较简单的方式。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>       <span class="k">void</span> <span class="nf">ReadBigFile2</span><span class="p">(</span><span class="kt">object</span> <span class="n">val</span><span class="p">)</span>
</span><span class='line'>     <span class="p">{</span>
</span><span class='line'>        <span class="kt">string</span> <span class="n">dataFile</span> <span class="p">=</span> <span class="p">(</span><span class="kt">string</span><span class="p">)</span> <span class="n">val</span> <span class="p">;</span> <span class="c1">// val is a reference to fName</span>
</span><span class='line'>        <span class="c1">// Do work to read and process dataFile</span>
</span><span class='line'>     <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>     <span class="k">public</span> <span class="k">void</span> <span class="nf">btnStartRead_Click</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>
</span><span class='line'>     <span class="p">{</span>
</span><span class='line'>        <span class="kt">string</span> <span class="n">fName</span> <span class="p">=</span> <span class="err">“</span><span class="n">BigDataFile</span><span class="p">.</span><span class="n">xml</span><span class="err">”</span> <span class="p">;</span>
</span><span class='line'>        <span class="n">WaitCallback</span> <span class="n">w</span> <span class="p">=</span> <span class="k">new</span> <span class="n">WaitCallback</span><span class="p">(</span><span class="n">ReadBigFile2</span><span class="p">)</span> <span class="p">;</span>
</span><span class='line'>        <span class="c1">// fName will be passed to ReadBigFile</span>
</span><span class='line'>        <span class="n">ThreadPool</span><span class="p">.</span><span class="n">QueueUserWorkItem</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">fName</span><span class="p">)</span> <span class="p">;</span>
</span><span class='line'>     <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>查看默认的线程池中辅助线程的最大数目和异步I/O线程的最大数目：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>   <span class="kt">int</span> <span class="n">workerThreads</span><span class="p">,</span> <span class="n">completionPortThreads</span><span class="p">;</span>
</span><span class='line'>  <span class="n">ThreadPool</span><span class="p">.</span><span class="n">GetMaxThreads</span><span class="p">(</span><span class="k">out</span> <span class="n">workerThreads</span><span class="p">,</span> <span class="k">out</span> <span class="n">completionPortThreads</span><span class="p">);</span>
</span><span class='line'>  <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">Debug</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">workerThreads</span><span class="p">);</span>  <span class="c1">// 25</span>
</span><span class='line'>  <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="n">Debug</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">completionPortThreads</span><span class="p">);</span><span class="c1">// 500</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以使用<code>ThreadPool.SetMaxThreads</code>方法按需修改。</p>

<h3>在后台任务中操纵UI控件</h3>

<p>将消息收发转到后台线程之后，就不能直接在收发消息时直接操纵UI控件了，需要在UI线程中定义好操纵控件的方法，然后在后台线程中使用<code>Control.Invoke</code>或者<code>Control.BeginInvoke</code>方法通过委托的方式进行调用，<code>Invoke</code>与<code>BeginInvoke</code>的区别是前者在进行委托调用时后台线程会阻塞，而后者使用的是异步委托调用。详细分析可以参考这几篇博文：</p>

<ul>
<li><a href="http://www.cnblogs.com/mashang/archive/2009/08/01/1536730.html" title="c# Invoke和BeginInvoke 区别">http://www.cnblogs.com/mashang/archive/2009/08/01/1536730.html</a></li>
<li><a href="http://blog.csdn.net/ansencumt/article/details/6024775" title="在WM下，获得当前路径处理和解决异常“Control.Invoke 必须用于与在独立线程上创建的控件交互。”">http://blog.csdn.net/ansencumt/article/details/6024775</a></li>
</ul>


<h3>关于WaitCursor</h3>

<p>在Android中执行后台任务时，我们通常会在界面上覆盖一个指示后台任务正在运行的ProgressDialog。</p>

<p>C#中可以使用<code>Cursor.Current = Cursors.WaitCursor;</code>来显示一个等待指示器。但是这时我们依然可以对界面中的控件进行操作，简单的解决方法是后台任务开始时使用<code>this.Enabled = false;</code>将当前窗体设为不可用，执行结束后<code>this.Enabled = true;</code>再恢复可用。缺点是整个界面会变成灰色。</p>

<ul>
<li><a href="http://www.codeproject.com/Questions/245525/wait-cursor-comes-but-still-i-am-able-to-click-the" title="wait cursor comes but still i am able to click the button">http://www.codeproject.com/Questions/245525/wait-cursor-comes-but-still-i-am-able-to-click-the</a></li>
</ul>


<h3>参考资料</h3>

<ul>
<li><a href="http://www.cnblogs.com/leslies2/archive/2012/02/07/2310495.html" title="C#综合揭秘——细说多线程（上）">http://www.cnblogs.com/leslies2/archive/2012/02/07/2310495.html</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/04/21/add-category-list-to-octopress/">为Octopress添加Categories侧边栏</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-04-21T01:23:05+08:00" pubdate data-updated="true">Apr 21<span>st</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h4>增加category_list插件</h4>

<p>保存到 plugins/category_list_tag.rb：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="c1"># encoding: UTF-8</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Jekyll</span>
</span><span class='line'>    <span class="k">class</span> <span class="nc">CategoryListTag</span> <span class="o">&lt;</span> <span class="ss">Liquid</span><span class="p">:</span><span class="ss">:Tag</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span><span class='line'>        <span class="n">html</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>        <span class="n">categories</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">registers</span><span class="o">[</span><span class="ss">:site</span><span class="o">].</span><span class="n">categories</span><span class="o">.</span><span class="n">keys</span>
</span><span class='line'>        <span class="n">categories</span><span class="o">.</span><span class="n">sort</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">category</span><span class="o">|</span>
</span><span class='line'>          <span class="n">posts_in_category</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">registers</span><span class="o">[</span><span class="ss">:site</span><span class="o">].</span><span class="n">categories</span><span class="o">[</span><span class="n">category</span><span class="o">].</span><span class="n">size</span>
</span><span class='line'>          <span class="n">category_dir</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">registers</span><span class="o">[</span><span class="ss">:site</span><span class="o">].</span><span class="n">config</span><span class="o">[</span><span class="s1">&#39;category_dir&#39;</span><span class="o">]</span>
</span><span class='line'>          <span class="n">html</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;&lt;li class=&#39;category&#39;&gt;&lt;a href=&#39;/</span><span class="si">#{</span><span class="n">category_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">category</span><span class="o">.</span><span class="n">to_url</span><span class="si">}</span><span class="s2">/&#39;&gt;</span><span class="si">#{</span><span class="n">category</span><span class="si">}</span><span class="s2"> (</span><span class="si">#{</span><span class="n">posts_in_category</span><span class="si">}</span><span class="s2">)&lt;/a&gt;&lt;/li&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>        <span class="n">html</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  
</span><span class='line'>  <span class="ss">Liquid</span><span class="p">:</span><span class="ss">:Template</span><span class="o">.</span><span class="n">register_tag</span><span class="p">(</span><span class="s1">&#39;category_list&#39;</span><span class="p">,</span> <span class="ss">Jekyll</span><span class="p">:</span><span class="ss">:CategoryListTag</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>注意</strong>：一定要在文件的开始添加<code># encoding: UTF-8</code>这一行，否则无法支持中文分类。</p>

<h4>增加aside</h4>

<p>保存到 source/_includes/asides/category_list.html：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'> <span class="nt">&lt;section&gt;</span>
</span><span class='line'>    <span class="nt">&lt;h1&gt;</span>Categories<span class="nt">&lt;/h1&gt;</span>
</span><span class='line'>    <span class="nt">&lt;ul</span> <span class="na">id=</span><span class="s">&quot;categories&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      \{\% category_list %\}\   //添加时去掉4个\
</span><span class='line'>    <span class="nt">&lt;/ul&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/section&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h4>修改_config.yml文件</h4>

<p>将category_list添加到default_asides：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="err">   </span><span class="l-Scalar-Plain">default_asides</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">asides/category_list.html</span><span class="p-Indicator">,</span> <span class="nv">asides/recent_posts.html</span><span class="p-Indicator">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>安装这个插件后直接可以支持中文分类，url中使用的是分类的拼音，如「数据库」对应「shu-ju-ku」。如果使用中文分类时遇到各种错误，请参考下面这两篇文章：</p>

<ul>
<li><a href="http://aiku.me/bar/10393365" title="Octopress博客分类添加中文支持">http://aiku.me/bar/10393365</a></li>
<li><a href="http://blog.sprabbit.com/blog/2012/03/23/octopress/" title="关于在64位 Windows 7 中部署中文化的Octopress">http://blog.sprabbit.com/blog/2012/03/23/octopress/</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/04/20/mysql-lock-and-unlock-tables/">MySQL锁表与解锁</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-04-20T20:14:04+08:00" pubdate data-updated="true">Apr 20<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>LOCK TABLES</h2>

<h3>锁表语法</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'>  <span class="k">LOCK</span> <span class="n">TABLES</span>
</span><span class='line'>      <span class="n">tbl_name</span> <span class="p">[[</span><span class="k">AS</span><span class="p">]</span> <span class="k">alias</span><span class="p">]</span> <span class="n">lock_type</span>
</span><span class='line'>      <span class="p">[,</span> <span class="n">tbl_name</span> <span class="p">[[</span><span class="k">AS</span><span class="p">]</span> <span class="k">alias</span><span class="p">]</span> <span class="n">lock_type</span><span class="p">]</span> <span class="p">...</span>
</span><span class='line'>  
</span><span class='line'>  <span class="n">lock_type</span><span class="p">:</span>
</span><span class='line'>      <span class="k">READ</span> <span class="p">[</span><span class="k">LOCAL</span><span class="p">]</span>
</span><span class='line'>    <span class="o">|</span> <span class="p">[</span><span class="n">LOW_PRIORITY</span><span class="p">]</span> <span class="k">WRITE</span>
</span></code></pre></td></tr></table></div></figure>


<p>会话只能为自己获取、释放锁，不能为其他会话获取锁，也不能释放其他会话持有的锁。</p>

<p><code>LOCK TABLES</code>隐式的为当前会话获取表锁。表锁的对象可以是表也可以是视图。</p>

<p>获取视图锁时，<code>LOCK TABLES</code>命令会自动锁定所有与该视图相关的基本表。</p>

<p>使用<code>LOCK TABLES</code>显示的锁定一个表时，这个表的触发器中涉及到的表也会被隐式的锁定，锁的类型取决于触发器中对该表进行了何种操作。</p>

<p>表锁只是用来防止其他会话进行不恰当的操作，持有锁的会话，即使持有的仅仅是读锁，也可以进行诸如<code>DROP TABLE</code>之类的表级操作。而由于<code>TRUNCATE</code>操作不是事务安全的，所以在活动的事务或者持有表锁时尝试执行<code>TRUNCATE</code>操作时会报错。</p>

<p>另外，虽然可以对临时表执行锁表操作，但是实际上会被自动忽略掉，不执行任何操作。因为临时表只对当前会话（也就是创建它的会话）是可见的。</p>

<h3>锁的类型</h3>

<h4>READ [LOCAL]锁</h4>

<ul>
<li>持有读锁的会话可以读表，但是不能写表。</li>
<li>多个会话可以同时获得同一个表的读锁。</li>
<li>其他的会话不用获取该表的读锁也可以读取该表。</li>
<li><code>LOCAL</code>修饰符允许其他会话执行无冲突的插入语句。但是，如果是在服务器之外的进程上进行操作时，就不能使用<code>READ LOCAL</code>了。另外，对于使用InnoDB引擎的表来说，<code>READ LOCAL</code>与<code>READ</code>没有任何区别。</li>
</ul>


<h4>[LOW_PRIORITY] WRITE锁</h4>

<ul>
<li>持有写锁的会话可以读表也可以写表。</li>
<li>只有持有写锁的会话可以访问该表。写锁释放前其他会话都不能对该表进行访问。</li>
<li>表被写锁锁定时，其他会话对该表的锁定请求将会被阻塞。</li>
<li><code>LOW_PRIORITY</code>修饰符已被弃用（当前版本为5.7）。直接使用<code>WRITE</code>即可。</li>
</ul>


<p>锁表语句会一直阻塞直到获取到所有需要的锁。
需要对表进行锁定的会话必须一次性的获取到所有它需要锁，因为一旦锁表语句执行完成，该会话就只能访问被锁的表了。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>   mysql&gt; LOCK TABLES t1 READ;
</span><span class='line'>  mysql&gt; SELECT COUNT<span class="o">(</span>*<span class="o">)</span> FROM t1;
</span><span class='line'>  +----------+
</span><span class='line'>  | COUNT<span class="o">(</span>*<span class="o">)</span> |
</span><span class='line'>  +----------+
</span><span class='line'>  |        3 |
</span><span class='line'>  +----------+
</span><span class='line'>  mysql&gt; SELECT COUNT<span class="o">(</span>*<span class="o">)</span> FROM t2;
</span><span class='line'>  ERROR 1100 <span class="o">(</span>HY000<span class="o">)</span>: Table <span class="s1">&#39;t2&#39;</span> was not locked with LOCK TABLES
</span></code></pre></td></tr></table></div></figure>


<p><code>INFORMATION_SCHEMA</code>数据库中的表是个例外。即使有会话对这些表进行了锁定，其他会话依然可以继续访问。</p>

<p>在一条查询语句中无法多次对锁定的表使用同一个名字进行引用。这种情况下可以使用表的别名，并且对每一个别也要加一个锁：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>   mysql&gt; LOCK TABLE t WRITE, t AS t1 READ;
</span><span class='line'>  mysql&gt; INSERT INTO t SELECT * FROM t;
</span><span class='line'>  ERROR 1100: Table <span class="s1">&#39;t&#39;</span> was not locked with LOCK TABLES
</span><span class='line'>  mysql&gt; INSERT INTO t SELECT * FROM t AS t1;
</span></code></pre></td></tr></table></div></figure>


<p>不对表的别名进行锁定的话，就无法使用别名对该表进行访问：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>   mysql&gt; LOCK TABLE t READ;
</span><span class='line'>  mysql&gt; SELECT * FROM t AS myalias;
</span><span class='line'>  ERROR 1100: Table <span class="s1">&#39;myalias&#39;</span> was not locked with LOCK TABLES
</span></code></pre></td></tr></table></div></figure>


<p>相反，如果只对别名进行了锁定，则只能使用别名对其进行访问：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>   mysql&gt; LOCK TABLE t AS myalias READ;
</span><span class='line'>  mysql&gt; SELECT * FROM t;
</span><span class='line'>  ERROR 1100: Table <span class="s1">&#39;t&#39;</span> was not locked with LOCK TABLES
</span><span class='line'>  mysql&gt; SELECT * FROM t AS myalias;
</span></code></pre></td></tr></table></div></figure>


<p>写锁通常相对读锁有更高的优先级，以确保更新操作尽快得到处理。这就意味着如果同时有写锁和读锁两个请求，那么写锁会先得到响应。<code>LOCK TABLES</code>获取锁的过程如下：</p>

<ol>
<li>使用内部定义的顺序对所有将被加锁的表进行排序，这一步对于用户来说是透明的。</li>
<li>如果一个表同时有读锁和写锁两个请求，将写锁请求放到读锁请求之前。</li>
<li>每次锁定一个表直到当前会话获取到所有的需要的锁，并保证不会产生死锁。</li>
</ol>


<p>对分表进行锁定和解锁时，会锁定或者解锁整个表。</p>

<h2>UNLOCK TABLES</h2>

<h3>解锁语法</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'>  <span class="n">UNLOCK</span> <span class="n">TABLES</span>
</span></code></pre></td></tr></table></div></figure>


<p>使用<code>UNLOCK TABLES</code>将显示的释放掉由当前会话持有的所有表锁。</p>

<p><code>LOCK TABLES</code>会在获取新锁之前隐式的释放掉当前会话持有的所有表锁。</p>

<p>会话开始一个事务（例如使用<code>START TRANSACTION</code>）时，会隐式的执行<code>UNLOCK TABLES</code>。</p>

<p>无论会话正常退出或者异常终止，服务器都会隐式的释放掉该会话持有的所有锁。客户端重新连接后，这些锁不会再生效。另外，如果客户端断开时正在执行一个事务，服务器会自动回滚该事务，客户端重连后，新会话将会自动设置为自动提交模式。因此，最好禁用客户端的auto-reconnec。在启用自动重连的情况下，重连后客户端其实已经丢失了所有的锁和事务，但是不会被通知。而当禁用掉自动重连时，一旦连接断开，在一个将被执行的语句处会报错。这样一来客户端就可以检测到这个错误，并采取适当的措施，比如重新获取需要的锁，重新执行之前的事务。</p>

<p>在被锁定的表上执行<code>ALTER TABLE</code>语句后，将使该表变为未锁定状态。如果对该表再执行一条<code>ALTER TABLE</code>语句，就会报错：Table &lsquo;tbl_name&rsquo; was not locked with LOCK TABLES。这种情况下可以在执行完第一条<code>ALTER TABLE</code>后，重新对该表进行锁定。</p>

<p><code>UNLOCK TABLES</code>还可以用来释放之前通过<code>FLUSH TABLES WITH READ LOCK</code>获得的全局读锁。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/04/18/summer-intern-interview-summary/">2014暑期实习面试</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-04-18T21:36:39+08:00" pubdate data-updated="true">Apr 18<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>腾讯移动客户端开发</h3>

<h4>一面</h4>

<ul>
<li>介绍项目</li>
<li>两道题目

<ul>
<li>如何从10亿个QQ号中快速查找给定的QQ号</li>
<li>RGB2YUV快速算法</li>
</ul>
</li>
<li>详细介绍项目中的移动端</li>
</ul>


<h4>二面</h4>

<ul>
<li>介绍项目，项目中的APP的亮点和技术难度</li>
<li>纸上写代码：单链表的反转</li>
<li>闲扯

<ul>
<li>用过最出色的APP、最差的APP</li>
<li>微信和QQ比较</li>
<li>微信哪些不足</li>
<li>还用过哪些其他的社交APP</li>
</ul>
</li>
</ul>


<h4>HR面</h4>

<p>都是轻松的话题</p>

<ul>
<li>本科学校</li>
<li>本科和研究生有没有开设Android的课程</li>
<li>Android是自学的吗，为什么不做IOS应用开发</li>
<li>哪里人，山东学生考北京学校的挺多</li>
<li>前两面的面试官有没有跟你说过你将来到公司做什么</li>
<li>做过前端，前端和客户端开发你更倾向于哪个</li>
<li>阿里校招有没有参加，结果如何</li>
<li>平时的兴趣爱好，水平如何</li>
<li>到哪看美剧</li>
<li>实习时间</li>
</ul>


<h3>阿里Java研发</h3>

<h4>一面</h4>

<ul>
<li>介绍项目

<ul>
<li>详细介绍项目开发中最有挑战性的部分</li>
<li>Spring框架的好处</li>
</ul>
</li>
<li>数据库

<ul>
<li>如何加锁</li>
<li>锁的级别</li>
<li>事务控制

<ul>
<li>给了一道题</li>
</ul>
</li>
<li>乐观锁、悲观锁</li>
<li>索引

<ul>
<li>索引的种类</li>
<li>聚簇索引</li>
<li>索引的结构

<ul>
<li>B+树</li>
</ul>
</li>
<li>红黑树</li>
</ul>
</li>
</ul>
</li>
<li>复杂的业务逻辑、对象依赖</li>
<li>面向对象的特征

<ul>
<li>举例说明</li>
</ul>
</li>
</ul>


<p>下面整理了一些大牛的面试总结：</p>

<ul>
<li>阿里Java研发一面：<a href="http://blog.csdn.net/henryfabrgeas/article/details/23700799" title="2014阿里巴巴面试经验-北京站研发工程师">http://blog.csdn.net/henryfabrgeas/article/details/23700799</a></li>
<li>阿里Java研发二面：<a href="http://blog.csdn.net/henryfabrgeas/article/details/24260553" title="阿里实习生2014二面总结">http://blog.csdn.net/henryfabrgeas/article/details/24260553</a></li>
<li>阿里C++研发电面：<a href="http://www.cnblogs.com/weixliu/p/3606401.html" title="阿里巴巴电话面试记录">http://www.cnblogs.com/weixliu/p/3606401.html</a></li>
<li>阿里C++研发现场面：<a href="http://www.cnblogs.com/weixliu/p/3659856.html" title="吐槽下阿里巴巴实习招聘">http://www.cnblogs.com/weixliu/p/3659856.html</a></li>
<li>腾讯软件开发北京笔试：<a href="http://www.cnblogs.com/weixliu/p/3667972.html" title="腾讯2014实习北京笔试">http://www.cnblogs.com/weixliu/p/3667972.html</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/04/07/faster-java-io-in-acm/">使用Java快速处理大数据量的输入</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-04-07T14:37:20+08:00" pubdate data-updated="true">Apr 7<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>这里以读取<code>int</code>类型的数据为例。</p>

<h3><code>Scanner</code></h3>

<h4>直接使用<code>nextInt()</code></h4>

<p>虽然是最方便的，但是也是最慢的。建议数据量小的时候使用。数据量大的情况下多半会超时。直接使用<code>nextInt()</code>方法的时候一般都会用<code>BufferedInputStream</code>封装一下输入流，速度能稍微快一些。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'> <span class="n">Scanner</span> <span class="n">scanner</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Scanner</span><span class="o">(</span><span class="k">new</span> <span class="n">BufferedInputStream</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">in</span><span class="o">));</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">long</span> <span class="n">rows</span> <span class="o">=</span> <span class="n">scanner</span><span class="o">.</span><span class="na">nextLong</span><span class="o">();</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">scanner</span><span class="o">.</span><span class="na">nextInt</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rows</span> <span class="o">*</span> <span class="n">cols</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>      <span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="n">scanner</span><span class="o">.</span><span class="na">nextInt</span><span class="o">();</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">scanner</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure>


<h4>使用<code>next()</code>, 然后手动<code>Integer.parseInt()</code></h4>

<p>这样能比直接使用<code>nextInt()</code>快不少，查看一下<code>nextInt()</code>的源码我们可以发现：<code>nextInt()</code>方法先用正则表达式从流中获取一个表示整型的字符串<code>s</code>，最后再返回<code>Integer.parseInt(s)</code>。多出的时间都消耗在进行模式匹配上了，这其实也就是直接使用<code>nextInt()</code>比较慢的原因之一。而如果我们事先知道输入的数据类型的话，就不用进行匹配，直接解析就可以了。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'> <span class="n">Scanner</span> <span class="n">scanner</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Scanner</span><span class="o">(</span><span class="k">new</span> <span class="n">BufferedInputStream</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">in</span><span class="o">));</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">long</span> <span class="n">rows</span> <span class="o">=</span> <span class="n">Long</span><span class="o">.</span><span class="na">parseLong</span><span class="o">(</span><span class="n">scanner</span><span class="o">.</span><span class="na">next</span><span class="o">());</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">scanner</span><span class="o">.</span><span class="na">next</span><span class="o">());</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rows</span> <span class="o">*</span> <span class="n">cols</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>      <span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">scanner</span><span class="o">.</span><span class="na">next</span><span class="o">());</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">scanner</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure>


<h3><code>BufferedReader</code> + <code>StringTokenizer</code></h3>

<p>使用<code>BufferedReader</code>按行读取，然后使用<code>StringTokenizer</code>获取每一行中使用空格符隔开的所有元素。速度甚至比C语言的<code>scanf()</code>还要快。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'> <span class="n">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="n">InputStreamReader</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">in</span><span class="o">));</span>
</span><span class='line'>    <span class="n">StringTokenizer</span> <span class="n">tokenizer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringTokenizer</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">tokenizer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringTokenizer</span><span class="o">(</span><span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">());</span>
</span><span class='line'>  <span class="kt">long</span> <span class="n">rows</span> <span class="o">=</span> <span class="n">Long</span><span class="o">.</span><span class="na">parseLong</span><span class="o">(</span><span class="n">tokenizer</span><span class="o">.</span><span class="na">nextToken</span><span class="o">());</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">tokenizer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringTokenizer</span><span class="o">(</span><span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">());</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">tokenizer</span><span class="o">.</span><span class="na">nextToken</span><span class="o">());</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rows</span> <span class="o">*</span> <span class="n">cols</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">while</span> <span class="o">(!</span><span class="n">tokenizer</span><span class="o">.</span><span class="na">hasMoreTokens</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">tokenizer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringTokenizer</span><span class="o">(</span><span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">());</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>      <span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">tokenizer</span><span class="o">.</span><span class="na">nextToken</span><span class="o">());</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">reader</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure>


<h3>实际测试结果</h3>

<p>用以上三种方式从文件中读取10,000,000个<code>int</code>型数值所消耗的时间分别为 11.52秒，7.486秒，2.159秒。使用gcc的<code>fscanf()</code>所用时间为 5.303秒。</p>

<p>读取10,000,000个<code>double</code>型数值所消耗的时间分别为 41.125秒，16.082秒，9.271秒。使用gcc的<code>fscanf()</code>所用时间为 11.279秒。</p>

<h3>总结</h3>

<p>虽然使用<code>BufferedReader</code>和<code>StringTokenizer</code>处理输入可以获得让人满意的速度，但是需要写的代码相对来说是比较多的。在ACM比赛时可以准备一个工具类，比赛开始时，让一个人先把这个类写出来备用。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'> <span class="cm">/** Class for buffered reading int and double values */</span>
</span><span class='line'>  <span class="kd">class</span> <span class="nc">Reader</span> <span class="o">{</span>
</span><span class='line'>      <span class="kd">static</span> <span class="n">BufferedReader</span> <span class="n">reader</span><span class="o">;</span>
</span><span class='line'>      <span class="kd">static</span> <span class="n">StringTokenizer</span> <span class="n">tokenizer</span><span class="o">;</span>
</span><span class='line'>  
</span><span class='line'>      <span class="cm">/** call this method to initialize reader for InputStream */</span>
</span><span class='line'>      <span class="kd">static</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">InputStream</span> <span class="n">input</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span>
</span><span class='line'>                       <span class="k">new</span> <span class="nf">InputStreamReader</span><span class="o">(</span><span class="n">input</span><span class="o">)</span> <span class="o">);</span>
</span><span class='line'>          <span class="n">tokenizer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringTokenizer</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  
</span><span class='line'>      <span class="cm">/** get next word */</span>
</span><span class='line'>      <span class="kd">static</span> <span class="n">String</span> <span class="nf">next</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>          <span class="k">while</span> <span class="o">(</span> <span class="o">!</span> <span class="n">tokenizer</span><span class="o">.</span><span class="na">hasMoreTokens</span><span class="o">()</span> <span class="o">)</span> <span class="o">{</span>
</span><span class='line'>              <span class="c1">//TODO add check for eof if necessary</span>
</span><span class='line'>              <span class="n">tokenizer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringTokenizer</span><span class="o">(</span>
</span><span class='line'>                     <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">()</span> <span class="o">);</span>
</span><span class='line'>          <span class="o">}</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">tokenizer</span><span class="o">.</span><span class="na">nextToken</span><span class="o">();</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  
</span><span class='line'>      <span class="kd">static</span> <span class="kt">int</span> <span class="nf">nextInt</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span> <span class="n">next</span><span class="o">()</span> <span class="o">);</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>      
</span><span class='line'>      <span class="kd">static</span> <span class="kt">double</span> <span class="nf">nextDouble</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">Double</span><span class="o">.</span><span class="na">parseDouble</span><span class="o">(</span> <span class="n">next</span><span class="o">()</span> <span class="o">);</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>参考资料</h4>

<ul>
<li><a href="http://www.cpe.ku.ac.th/~jim/java-io.html">http://www.cpe.ku.ac.th/~jim/java-io.html</a></li>
<li><a href="http://stackoverflow.com/questions/2446805/is-java-util-scanner-that-slow">http://stackoverflow.com/questions/2446805/is-java-util-scanner-that-slow</a></li>
<li><a href="http://spc10.contest.scrool.se/doc/javaio">http://spc10.contest.scrool.se/doc/javaio</a></li>
<li><a href="http://www.javamex.com/tutorials/regular_expressions/splitting_tokenisation_performance.shtml">http://www.javamex.com/tutorials/regular_expressions/splitting_tokenisation_performance.shtml</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/04/06/octopress-custom-modifications/">Octopress自定义修改记录</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-04-06T16:46:35+08:00" pubdate data-updated="true">Apr 6<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>按照<a href="http://octopress.org/docs/">官方教程</a>部署好Octopress后，如果想要支持中文blog的书写，需要修改以下几个地方：</p>

<h3>环境变量</h3>

<p>如果在Windows操作系统下，需要添加两个环境变量：</p>

<ul>
<li>LANG = zh_CN.UTF-8</li>
<li>LC_ALL = zh_CN.UTF-8</li>
</ul>


<h3>Jekyll</h3>

<p>修改<code>{ruby_home}\lib\ruby\gems\1.9.1\gems\jekyll-0.12.0\lib\jekyll\convertible.rb</code>，强制使用UTF-8格式：</p>

<div><script src='https://gist.github.com/e7b7d3cee4bcfe85dcc7.js?file=convertible.rb.diff'></script>
<script type="text/javascript">$(".gist-file table tr td.line-numbers").remove();</script>
<noscript><pre><code>@@ -25,7 +25,7 @@ def to_s
     #
     # Returns nothing.
     def read_yaml(base, name)
-      self.content = File.read(File.join(base, name))
+      self.content = File.read(File.join(base, name), :encoding =&gt; 'utf-8')
 
       begin
         if self.content =~ /\A(---\s*\n.*?\n?)^(---\s*$\n?)/m</code></pre></noscript></div>


<p>其他的一些修改：</p>

<h3>提交时间</h3>

<p>运行<code>rake deploy</code>时，在Rakefile中可以找到默认的提交信息是「Site updated at #{Time.now.utc}」，这里的时间是UTC时间，将<code>Time.now.utc</code>改成<code>Time.now</code>就可以使用本地的时间了。</p>

<div><script src='https://gist.github.com/e7b7d3cee4bcfe85dcc7.js?file=Rakefile.diff'></script>
<script type="text/javascript">$(".gist-file table tr td.line-numbers").remove();</script>
<noscript><pre><code>@@ -261,8 +261,8 @@ multitask :push do
    cp_r &quot;#{public_dir}/.&quot;, deploy_dir
    cd &quot;#{deploy_dir}&quot; do
      system &quot;git add -A&quot;
 -    puts &quot;\n## Committing: Site updated at #{Time.now.utc}&quot;
 -    message = &quot;Site updated at #{Time.now.utc}&quot;
 +    puts &quot;\n## Committing: Site updated at #{Time.now}&quot;
 +    message = &quot;Site updated at #{Time.now}&quot;
      system &quot;git commit -m \&quot;#{message}\&quot;&quot;
      puts &quot;\n## Pushing generated #{deploy_dir} website&quot;
      system &quot;git push origin #{deploy_branch}&quot;</code></pre></noscript></div>


<h3>JiaThis插件</h3>

<p>添加JiaThis分享插件后，会发现在分享工具条左下角出现一个小白框，遮挡住了「分享至」里的「分」字，影响视觉效果。Google了一下发现了解决方案：</p>

<p>修改<code>octopress\source\javascripts\octopress.js</code>：</p>

<div><script src='https://gist.github.com/e7b7d3cee4bcfe85dcc7.js?file=octopress.js.diff'></script>
<script type="text/javascript">$(".gist-file table tr td.line-numbers").remove();</script>
<noscript><pre><code>@@ -94,7 +94,9 @@ function flashVideoFallback(){
  function wrapFlashVideos() {
    $('object').each(function(i, object) {
      if( $(object).find('param[name=movie]').length ){
 -      $(object).wrap('&lt;div class=&quot;flash-video&quot;&gt;')
 +      if ($(object).attr('id') != &quot;JIATHISSWF&quot;) {
 +          $(object).wrap('&lt;div class=&quot;flash-video&quot;&gt;')
 +      }
      }
    });
    $('iframe[src*=vimeo],iframe[src*=youtube]').wrap('&lt;div class=&quot;flash-video&quot;&gt;')</code></pre></noscript></div>


<p>解决方案源地址：<a href="http://geeksavetheworld.com/blog/2012/11/05/add-jiathis-to-octopress-blog/">http://geeksavetheworld.com/blog/2012/11/05/add-jiathis-to-octopress-blog/</a></p>

<h3>列表缩进样式</h3>

<p>默认的css样式文件中，markdown的列表是没有进行缩进处理的，看着比较别扭。找到<code>octopress\sass\custom\_layout.scss</code>，去掉<code>//$indented-lists: true;</code>这一行的注释符号，重新<code>rake generate</code>就可以了。</p>

<div><script src='https://gist.github.com/e7b7d3cee4bcfe85dcc7.js?file=_layout.scss.diff'></script>
<script type="text/javascript">$(".gist-file table tr td.line-numbers").remove();</script>
<noscript><pre><code>@@ -6,7 +6,7 @@
  //$header-padding-bottom: 1.5em;
  
  //$max-width: 1350px;
- //$indented-lists: true;
+ $indented-lists: true;
  
  // Padding used for layout margins
  //$pad-min: 18px;</code></pre></noscript></div>


<h3>Gist tag</h3>

<p>修复Gist tag的样式。参见：<a href="http://devspade.com/blog/2013/08/06/fixing-gist-embeds-in-octopress/">http://devspade.com/blog/2013/08/06/fixing-gist-embeds-in-octopress/</a></p>

<h3>Codeblock插件</h3>

<p>现在<a href="https://github.com/imathis/octopress">官方Github</a>的master分支下为Octopress2.0版本，暂不支持Codeblock插件中的start, mark, linenos选项，可以参考这两个临时解决方法：</p>

<ul>
<li><a href="https://github.com/imathis/octopress/issues/1472">https://github.com/imathis/octopress/issues/1472</a></li>
<li><a href="https://github.com/imathis/octopress/pull/1485">https://github.com/imathis/octopress/pull/1485</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/04/06/java-8-annotations/">Java 8 简明教程(10): Annotations</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-04-06T16:10:57+08:00" pubdate data-updated="true">Apr 6<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Annotations</h3>

<p>Java 8 中 annotations 是可重复的。我们通过下面这里例子来看一下。</p>

<p>首先，我们定义一个包装器annotation，其中存放着真正的annotations的数组：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'> <span class="nd">@interface</span> <span class="n">Hints</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">Hint</span><span class="o">[]</span> <span class="nf">value</span><span class="o">();</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="nd">@Repeatable</span><span class="o">(</span><span class="n">Hints</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'>  <span class="nd">@interface</span> <span class="n">Hint</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">String</span> <span class="nf">value</span><span class="o">();</span>
</span><span class='line'>  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Java 8 中我们可以使用添加<code>@Repeatable</code>来使用多个同种类型的注解。</p>

<p>变体1：使用容器annotation（过去的方法）</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'> <span class="nd">@Hints</span><span class="o">({</span><span class="nd">@Hint</span><span class="o">(</span><span class="s">&quot;hint1&quot;</span><span class="o">),</span> <span class="nd">@Hint</span><span class="o">(</span><span class="s">&quot;hint2&quot;</span><span class="o">)})</span>
</span><span class='line'>  <span class="kd">class</span> <span class="nc">Person</span> <span class="o">{}</span>
</span></code></pre></td></tr></table></div></figure>


<p>变体2：使用可重复的annotations（新式方法）</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'> <span class="nd">@Hint</span><span class="o">(</span><span class="s">&quot;hint1&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="nd">@Hint</span><span class="o">(</span><span class="s">&quot;hint2&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">class</span> <span class="nc">Person</span> <span class="o">{}</span>
</span></code></pre></td></tr></table></div></figure>


<p>使用变体2时，java编译器隐式的使用了<code>@Hints</code>注解。这在通过反射获取注解信息时显得尤为重要。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'> <span class="n">Hint</span> <span class="n">hint</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getAnnotation</span><span class="o">(</span><span class="n">Hint</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>  <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">hint</span><span class="o">);</span>                   <span class="c1">// null</span>
</span><span class='line'>  
</span><span class='line'>  <span class="n">Hints</span> <span class="n">hints1</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getAnnotation</span><span class="o">(</span><span class="n">Hints</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>  <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">hints1</span><span class="o">.</span><span class="na">value</span><span class="o">().</span><span class="na">length</span><span class="o">);</span>  <span class="c1">// 2</span>
</span><span class='line'>  
</span><span class='line'>  <span class="n">Hint</span><span class="o">[]</span> <span class="n">hints2</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getAnnotationsByType</span><span class="o">(</span><span class="n">Hint</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>  <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">hints2</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>          <span class="c1">// 2</span>
</span></code></pre></td></tr></table></div></figure>


<p>尽管我们在<code>Person</code>类上从未声明过<code>@Hints</code>，但是仍然可以通过<code>getAnnotation(Hints.class)</code>访问到它。然而，还有一个更方便的方法<code>getAnnotationsByType</code>，通过它能直接获取到所有标注为<code>@Hint</code>的注解。</p>

<p>另外，Java 8 中的annotations还扩展了两个新的target：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'> 
</span><span class='line'>  <span class="nd">@Target</span><span class="o">({</span><span class="n">ElementType</span><span class="o">.</span><span class="na">TYPE_PARAMETER</span><span class="o">,</span> <span class="n">ElementType</span><span class="o">.</span><span class="na">TYPE_USE</span><span class="o">})</span>
</span><span class='line'>  <span class="nd">@interface</span> <span class="n">MyAnnotation</span> <span class="o">{}</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/05/19/dealing-with-tcp-stick-package/">TCP Stick Package</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/04/26/java-classloader/">Java基础之ClassLoader</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/04/22/2014-alibaba-summer-intern-2nd-interview/">阿里校园招聘暑期实习二面面经</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/04/21/dot-net-compact-framework-background-task/">在.NET Compact Framework中使用后台任务</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/04/21/add-category-list-to-octopress/">为Octopress添加Categories侧边栏</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Categories</h1>
  <ul id="categories">
    <li class='category'><a href='/blog/categories/csharp/'>CSharp (1)</a></li>
<li class='category'><a href='/blog/categories/java/'>Java (12)</a></li>
<li class='category'><a href='/blog/categories/networking/'>Networking (1)</a></li>
<li class='category'><a href='/blog/categories/octopress/'>Octopress (2)</a></li>
<li class='category'><a href='/blog/categories/shu-ju-ku/'>数据库 (1)</a></li>
<li class='category'><a href='/blog/categories/mian-shi/'>面试 (2)</a></li>

  </ul>
</section>




<section>
  <h1>访客地图</h1>
  <script type="text/javascript" src="http://ji.revolvermaps.com/2/1.js?i=858ep4o6xm8&amp;s=220&amp;m=0&amp;v=false&amp;r=false&amp;b=000000&amp;n=false&amp;c=ff0000" async="async"></script>
</section>


  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Solo Hsu -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
